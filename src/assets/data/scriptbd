
-- ==========================================
-- TABLAS INDEPENDIENTES
-- ==========================================

CREATE TABLE Usuarios (
    id_usuario INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre_usuario TEXT UNIQUE NOT NULL,
    nombre TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL,
    fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    foto_perfil TEXT
);

CREATE INDEX idx_usuarios_email ON Usuarios(email);

CREATE TABLE Paises (
    id_pais INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT UNIQUE NOT NULL
);

CREATE INDEX idx_paises_nombre ON Paises(nombre);

CREATE TABLE Categorias (
    id_categoria INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT UNIQUE NOT NULL
);

CREATE INDEX idx_categorias_nombre ON Categorias(nombre);

CREATE TABLE Estados_Viaje (
    id_estado INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT UNIQUE NOT NULL
);

-- ==========================================
-- TABLAS DEPENDIENTES
-- ==========================================

CREATE TABLE Ciudades (
    id_ciudad INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT NOT NULL,
    id_pais INTEGER NOT NULL,
    FOREIGN KEY (id_pais) REFERENCES Paises(id_pais) ON DELETE CASCADE
);

CREATE INDEX idx_ciudades_pais ON Ciudades(id_pais, nombre);

CREATE TABLE Recuperaciones (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    id_usuario INTEGER NOT NULL,
    token TEXT NOT NULL,
    expiracion DATETIME NOT NULL,
    confirmado INTEGER DEFAULT 0,
    FOREIGN KEY (id_usuario) REFERENCES Usuarios(id_usuario) ON DELETE CASCADE
);

CREATE INDEX idx_recuperaciones_token ON Recuperaciones(token);
CREATE INDEX idx_recuperaciones_usuario ON Recuperaciones(id_usuario);

CREATE TABLE Viajes (
    id_viaje INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT NOT NULL,
    descripcion TEXT,
    fecha_inicio DATE,
    fecha_fin DATE,
    id_usuario INTEGER NOT NULL,
    id_estado INTEGER DEFAULT 1,
    FOREIGN KEY (id_usuario) REFERENCES Usuarios(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY (id_estado) REFERENCES Estados_Viaje(id_estado) ON DELETE SET NULL
);

CREATE INDEX idx_viajes_usuario ON Viajes(id_usuario);
CREATE INDEX idx_viajes_fecha ON Viajes(fecha_inicio);

CREATE TABLE Lugares (
    id_lugar INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT NOT NULL,
    descripcion TEXT,
    precio REAL DEFAULT 0.0,
    valoracion REAL DEFAULT 0.0,
    latitud REAL NOT NULL,
    longitud REAL NOT NULL,
    imagen1 TEXT,
    imagen2 TEXT,
    imagen3 TEXT,
    id_ciudad INTEGER NOT NULL,
    FOREIGN KEY (id_ciudad) REFERENCES Ciudades(id_ciudad) ON DELETE CASCADE
);

CREATE INDEX idx_lugares_nombre ON Lugares(nombre);
CREATE INDEX idx_lugares_ciudad ON Lugares(id_ciudad);
CREATE INDEX idx_lugares_precio ON Lugares(precio);
CREATE INDEX idx_lugares_valoracion ON Lugares(valoracion);
CREATE INDEX idx_lugares_geo ON Lugares(latitud, longitud);

CREATE TABLE Tareas (
    id_tarea INTEGER PRIMARY KEY AUTOINCREMENT,
    descripcion TEXT NOT NULL,
    estado TEXT CHECK (estado IN ('pendiente', 'completada')) DEFAULT 'pendiente',
    prioridad TEXT CHECK (prioridad IN ('baja', 'media', 'alta')) DEFAULT 'media',
    id_viaje INTEGER NOT NULL,
    FOREIGN KEY (id_viaje) REFERENCES Viajes(id_viaje) ON DELETE CASCADE
);

CREATE INDEX idx_tareas_viaje ON Tareas(id_viaje);
CREATE INDEX idx_tareas_estado ON Tareas(estado);

-- ==========================================
-- RELACIONES MUCHOS A MUCHOS
-- ==========================================

CREATE TABLE Lugares_Categorias (
    id_lugar INTEGER,
    id_categoria INTEGER,
    PRIMARY KEY (id_lugar, id_categoria),
    FOREIGN KEY (id_lugar) REFERENCES Lugares(id_lugar) ON DELETE CASCADE,
    FOREIGN KEY (id_categoria) REFERENCES Categorias(id_categoria) ON DELETE CASCADE
);

CREATE INDEX idx_lugares_cat_categoria ON Lugares_Categorias(id_categoria);

CREATE TABLE Viajes_Lugares (
    id_viaje INTEGER,
    id_lugar INTEGER,
    asistio INTEGER DEFAULT 0,
    confirmado INTEGER DEFAULT 0,
    PRIMARY KEY (id_viaje, id_lugar),
    FOREIGN KEY (id_viaje) REFERENCES Viajes(id_viaje) ON DELETE CASCADE,
    FOREIGN KEY (id_lugar) REFERENCES Lugares(id_lugar) ON DELETE CASCADE
);

CREATE INDEX idx_viajes_lugares_lugar ON Viajes_Lugares(id_lugar);
CREATE INDEX idx_viajes_lugares_asistio ON Viajes_Lugares(asistio);

CREATE TABLE Favoritos (
    id_usuario INTEGER,
    id_lugar INTEGER,
    fecha_agregado TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id_usuario, id_lugar),
    FOREIGN KEY (id_usuario) REFERENCES Usuarios(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY (id_lugar) REFERENCES Lugares(id_lugar) ON DELETE CASCADE
);

CREATE INDEX idx_favoritos_lugar ON Favoritos(id_lugar);
CREATE INDEX idx_favoritos_fecha ON Favoritos(fecha_agregado);

CREATE TABLE Resenas (
    id_resena INTEGER PRIMARY KEY AUTOINCREMENT,
    id_usuario INTEGER NOT NULL,
    id_lugar INTEGER NOT NULL,
    comentario TEXT,
    puntuacion INTEGER CHECK (puntuacion BETWEEN 1 AND 5) NOT NULL,
    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_usuario) REFERENCES Usuarios(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY (id_lugar) REFERENCES Lugares(id_lugar) ON DELETE CASCADE
);

CREATE INDEX idx_resenas_lugar ON Resenas(id_lugar);
CREATE INDEX idx_resenas_usuario ON Resenas(id_usuario);
CREATE INDEX idx_resenas_puntuacion ON Resenas(puntuacion);

CREATE TABLE Visitas_Manual (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    id_usuario INTEGER NOT NULL,
    id_lugar INTEGER NOT NULL,
    fecha_visita DATE NOT NULL,
    comentario TEXT,
    FOREIGN KEY (id_usuario) REFERENCES Usuarios(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY (id_lugar) REFERENCES Lugares(id_lugar) ON DELETE CASCADE
);

CREATE INDEX idx_visitas_usuario ON Visitas_Manual(id_usuario);
CREATE INDEX idx_visitas_fecha ON Visitas_Manual(fecha_visita);


-- ==========================================
-- INSERCIÓN DE DATOS INICIALES
-- ==========================================

-- Estados de Viaje
INSERT INTO Estados_Viaje (nombre) VALUES 
('Planned'), ('In Progress'), ('Completed'), ('Cancelled');

-- Categorías de lugares
INSERT INTO Categorias (nombre) VALUES 
('Beach'), ('Mountain'), ('City'), ('Museum'),
('Natural Park'), ('Historical Monument'), ('Gastronomy'),
('History'), ('Nature'), ('Art'), ('Religion');

-- Países
INSERT INTO Paises (nombre) VALUES 
('Spain'), ('Italy'), ('Germany');

-- Ciudades
INSERT INTO Ciudades (nombre, id_pais) VALUES 
('Granada', 1),
('Barcelona', 1),
('Rome', 2),
('Florence', 2),
('Berlin', 3);

-- ==========================================
-- INSERCIÓN DE LUGARES TURÍSTICOS
-- ==========================================

INSERT INTO Lugares (nombre, descripcion, precio, valoracion, latitud, longitud, imagen1, imagen2, imagen3, id_ciudad) VALUES
('The Alhambra', 'Impressive palace complex and fortress from the Muslim era.', 14.0, 4.8, 37.1760783, -3.5881413,
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1731884455/Travelle/espana/alhambra/img1.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1731884454/Travelle/espana/alhambra/img2.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1731884454/Travelle/espana/alhambra/img3.jpg', 1),

('Generalife', 'Beautiful gardens and summer palace of the Nasrid sultans.', 7.0, 4.6, 37.1775, -3.5883,
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1740407392/Travelle/espana/generalife/echuabdug8vzzqdqz5eb.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1740407392/Travelle/espana/generalife/pbohksex3hekccvtb0tx.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1740407391/Travelle/espana/generalife/rtjbcxll1qmgivevwo3i.jpg', 1),

('Sagrada Família Basilica', 'Unfinished masterpiece by Antoni Gaudí and symbol of Barcelona.', 26.0, 4.8, 41.4036299, 2.1743558,
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1731940950/Travelle/espana/sagradaFamilia/img1.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1731940950/Travelle/espana/sagradaFamilia/img2.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1731940950/Travelle/espana/sagradaFamilia/img3.jpg', 2),

('Park Güell', 'Public park with architectural elements designed by Antoni Gaudí.', 10.0, 4.6, 41.4144948, 2.1526945,
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1731886605/Travelle/espana/guell/img1.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1731886605/Travelle/espana/guell/img2.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1731886605/Travelle/espana/guell/img3.jpg', 2),

('Casa Batlló', 'Modernist building designed by Antoni Gaudí, known for its organic façade.', 35.0, 4.7, 41.3917, 2.1649,
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1731885051/Travelle/espana/casaBatllo/img3.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1731885051/Travelle/espana/casaBatllo/img1.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1731885051/Travelle/espana/casaBatllo/img2.jpg', 2),

('Roman Colosseum', 'Largest amphitheater ever built during the Roman Empire.', 18.0, 4.7, 41.8902102, 12.4922309,
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1731941637/Travelle/italia/coliseoRomano/img1.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1731941636/Travelle/italia/coliseoRomano/img2.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1731941636/Travelle/italia/coliseoRomano/img3.jpg', 3),

('St. Peter''s Basilica', 'The largest church in the world and center of Catholicism.', 0.0, 4.9, 41.9021667, 12.4539367,
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1740407782/Travelle/italia/Bas%C3%ADlica%20de%20San%20Pedro/pv5z3hgvcbgqi2fratjk.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1740407782/Travelle/italia/Bas%C3%ADlica%20de%20San%20Pedro/p2ovkabijlcck3yrho8l.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1740407781/Travelle/italia/Bas%C3%ADlica%20de%20San%20Pedro/hrfgwhmlejflzmqvmgs2.jpg', 3),

('Florence Cathedral', 'Impressive cathedral with its characteristic red dome, work of Brunelleschi.', 0.0, 4.8, 43.7731, 11.2560,
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1740407982/Travelle/italia/catedralFlorencia/yvefvcx9evwbnde61snu.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1740407981/Travelle/italia/catedralFlorencia/tsu8vwalo62gphqltaeb.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1740407981/Travelle/italia/catedralFlorencia/f6mtmfrluxnefxebejjl.jpg', 4),

('Ponte Vecchio', 'Famous medieval bridge over the Arno River with jewelry shops.', 0.0, 4.7, 43.7680, 11.2531,
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1740408135/Travelle/italia/ponte/plioqsxvzfctchbwjh1j.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1740408135/Travelle/italia/ponte/zrq3tmlkftgvdxs26psi.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1740408135/Travelle/italia/ponte/tuvrls9fbultcxixd5mw.jpg', 4),

('Brandenburg Gate', 'Neoclassical monument and symbol of German reunification.', 0.0, 4.8, 52.5163, 13.3777,
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1740408385/Travelle/alemania/puertaBrandeburgo/sbxsc6inxabvfyevzusj.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1740408385/Travelle/alemania/puertaBrandeburgo/sbxsc6inxabvfyevzusj.jpg',
 'https://res.cloudinary.com/dxhxsxijx/image/upload/v1740408385/Travelle/alemania/puertaBrandeburgo/ug8ovkjczzbeh8cwscna.jpg', 5);

-- ==========================================
-- RELACIONES LUGARES - CATEGORÍAS
-- ==========================================

INSERT INTO Lugares_Categorias (id_lugar, id_categoria) VALUES
(1, 8),
(2, 9),
(3, 10),
(4, 9),
(5, 10),
(6, 8),
(7, 11),
(8, 10),
(9, 8),
(10, 8);



